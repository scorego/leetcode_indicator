<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LeetCode Indicator - 程序员市场趋势</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .description {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }
    .chart-container {
      position: relative;
      height: 400px;
      margin-bottom: 40px;
    }
    .problem-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .problem-card {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .problem-card h3 {
      margin-top: 0;
      color: #333;
    }
    .online-users {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    .last-updated {
      text-align: center;
      color: #999;
      margin-top: 30px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>LeetCode Indicator</h1>
    <p class="description">通过LeetCode题目在线人数反映程序员市场趋势</p>
    
    <div style="text-align: center; margin-bottom: 20px;">
      <label for="language">语言：</label>
      <select id="language" onchange="changeLanguage()">
        <option value="zh">中文</option>
        <option value="en">English</option>
      </select>
      &nbsp;&nbsp;&nbsp;
      <label for="timeWindow">时间窗口：</label>
      <select id="timeWindow" onchange="updateChart()">
        <option value="7">最近7天</option>
        <option value="30" selected>最近30天</option>
        <option value="90">最近90天</option>
        <option value="all">全部</option>
      </select>
      &nbsp;&nbsp;&nbsp;
      <label for="timeDimension">时间维度：</label>
      <select id="timeDimension" onchange="updateChart()">
        <option value="hour">小时级别</option>
        <option value="day">天级别（平均值）</option>
      </select>
    </div>
    
    <div class="chart-container">
      <canvas id="trendChart"></canvas>
    </div>
    
    <div class="problem-cards" id="problemCards">
      <!-- 问题卡片将通过JavaScript动态生成 -->
    </div>
    
    <p class="last-updated" id="lastUpdated">最后更新: 加载中...</p>
  </div>

  <script>
    // 加载数据
    async function loadData() {
      try {
        const response = await fetch('data/online_users.json');
        if (!response.ok) {
          throw new Error('Failed to load data');
        }
        return await response.json();
      } catch (error) {
        console.error('Error loading data:', error);
        return [];
      }
    }

    // 聚合数据为天级别（计算平均值）
    function aggregateDataByDay(data) {
      if (data.length === 0) {
        return [];
      }
      
      // 按天分组
      const groupedByDay = {};
      data.forEach(item => {
        const date = new Date(item.timestamp);
        const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        
        if (!groupedByDay[dayKey]) {
          groupedByDay[dayKey] = {
            timestamp: new Date(dayKey).toISOString(),
            problems: []
          };
        }
        
        // 合并问题数据
        item.problems.forEach(problem => {
          const existingProblem = groupedByDay[dayKey].problems.find(p => p.name === problem.name);
          if (existingProblem) {
            existingProblem.online_users_sum += problem.online_users;
            existingProblem.count += 1;
          } else {
            groupedByDay[dayKey].problems.push({
              name: problem.name,
              url: problem.url,
              online_users_sum: problem.online_users,
              count: 1
            });
          }
        });
      });
      
      // 计算每天的平均值
      const aggregatedData = Object.values(groupedByDay).map(dayData => {
        return {
          timestamp: dayData.timestamp,
          problems: dayData.problems.map(problem => ({
            name: problem.name,
            url: problem.url,
            online_users: Math.round(problem.online_users_sum / problem.count)
          }))
        };
      });
      
      // 按时间排序
      aggregatedData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      return aggregatedData;
    }

    // 根据时间窗口过滤数据
    function filterDataByTimeWindow(data, days) {
      if (days === 'all') {
        return data;
      }
      
      const daysNum = parseInt(days);
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - daysNum);
      
      return data.filter(item => new Date(item.timestamp) >= cutoffDate);
    }

    // 更新图表
    function updateChart() {
      const timeWindow = document.getElementById('timeWindow').value;
      const timeDimension = document.getElementById('timeDimension').value;
      loadData().then(data => {
        const filteredData = filterDataByTimeWindow(data, timeWindow);
        drawTrendChart(filteredData, timeDimension);
      });
    }

    // 语言映射对象
    const translations = {
      zh: {
        title: 'LeetCode Indicator',
        description: '通过LeetCode题目在线人数反映程序员市场趋势',
        language: '语言：',
        timeWindow: '时间窗口：',
        timeWindow7: '最近7天',
        timeWindow30: '最近30天',
        timeWindow90: '最近90天',
        timeWindowAll: '全部',
        timeDimension: '时间维度：',
        hourLevel: '小时级别',
        dayLevel: '天级别（平均值）',
        onlineUsers: '在线人数',
        lastUpdated: '最后更新: ',
        chartTitleHour: 'LeetCode题目在线人数趋势 (小时级别)',
        chartTitleDay: 'LeetCode题目在线人数趋势 (天级别平均值)',
        chartXAxisHour: '时间（小时）',
        chartXAxisDay: '日期',
        chartYAxis: '在线人数',
        noData: '暂无数据'
      },
      en: {
        title: 'LeetCode Indicator',
        description: 'Reflecting programmer job market trends through LeetCode problem online users',
        language: 'Language: ',
        timeWindow: 'Time Window: ',
        timeWindow7: 'Last 7 Days',
        timeWindow30: 'Last 30 Days',
        timeWindow90: 'Last 90 Days',
        timeWindowAll: 'All',
        timeDimension: 'Time Dimension: ',
        hourLevel: 'Hourly',
        dayLevel: 'Daily (Average)',
        onlineUsers: 'Online Users',
        lastUpdated: 'Last Updated: ',
        chartTitleHour: 'LeetCode Problem Online Users Trend (Hourly)',
        chartTitleDay: 'LeetCode Problem Online Users Trend (Daily Average)',
        chartXAxisHour: 'Time (Hour)',
        chartXAxisDay: 'Date',
        chartYAxis: 'Online Users',
        noData: 'No Data Available'
      }
    };

    // 切换语言
    function changeLanguage() {
      const language = document.getElementById('language').value;
      updateUI(language);
      // 重新加载数据和图表以更新文本
      loadData().then(data => {
        generateProblemCards(data);
        const timeWindow = document.getElementById('timeWindow').value;
        const timeDimension = document.getElementById('timeDimension').value;
        const filteredData = filterDataByTimeWindow(data, timeWindow);
        drawTrendChart(filteredData, timeDimension);
      });
    }

    // 更新UI文本
    function updateUI(language) {
      const lang = translations[language];
      
      // 更新标题和描述
      document.querySelector('h1').textContent = lang.title;
      document.querySelector('.description').textContent = lang.description;
      
      // 更新标签
      document.querySelector('label[for="language"]').textContent = lang.language;
      document.querySelector('label[for="timeWindow"]').textContent = lang.timeWindow;
      document.querySelector('label[for="timeDimension"]').textContent = lang.timeDimension;
      
      // 更新时间窗口选项
      const timeWindowSelect = document.getElementById('timeWindow');
      timeWindowSelect.options[0].text = lang.timeWindow7;
      timeWindowSelect.options[1].text = lang.timeWindow30;
      timeWindowSelect.options[2].text = lang.timeWindow90;
      timeWindowSelect.options[3].text = lang.timeWindowAll;
      
      // 更新时间维度选项
      const timeDimensionSelect = document.getElementById('timeDimension');
      timeDimensionSelect.options[0].text = lang.hourLevel;
      timeDimensionSelect.options[1].text = lang.dayLevel;
      
      // 更新问题卡片中的文本
      const problemCards = document.querySelectorAll('.problem-card p');
      problemCards.forEach(card => {
        if (card.textContent === '在线人数' || card.textContent === 'Online Users') {
          card.textContent = lang.onlineUsers;
        }
      });
      
      // 更新最后更新时间文本
      const lastUpdatedEl = document.getElementById('lastUpdated');
      if (lastUpdatedEl.textContent.includes('最后更新:') || lastUpdatedEl.textContent.includes('Last Updated:')) {
        const timePart = lastUpdatedEl.textContent.split(/最后更新: |Last Updated: /)[1];
        lastUpdatedEl.textContent = lang.lastUpdated + timePart;
      }
    }

    // 生成问题卡片
    function generateProblemCards(data) {
      const container = document.getElementById('problemCards');
      container.innerHTML = '';
      
      const language = document.getElementById('language').value;
      const lang = translations[language];
      
      if (data.length === 0) {
        container.innerHTML = `<p>${lang.noData}</p>`;
        return;
      }
      
      // 获取最新的数据
      const latestData = data[data.length - 1];
      
      // 更新最后更新时间
      const lastUpdatedEl = document.getElementById('lastUpdated');
      lastUpdatedEl.textContent = `${lang.lastUpdated}${new Date(latestData.timestamp).toLocaleString()}`;
      
      // 生成卡片
      latestData.problems.forEach(problem => {
        const card = document.createElement('div');
        card.className = 'problem-card';
        card.innerHTML = `
          <h3>${problem.name}</h3>
          <div class="online-users">${problem.online_users}</div>
          <p>${lang.onlineUsers}</p>
        `;
        container.appendChild(card);
      });
    }

    // 绘制趋势图
    function drawTrendChart(data, timeDimension) {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      if (data.length === 0) {
        return;
      }
      
      const language = document.getElementById('language').value;
      const lang = translations[language];
      
      // 根据时间维度处理数据
      let processedData = data;
      if (timeDimension === 'day') {
        processedData = aggregateDataByDay(data);
      }
      
      // 提取所有问题名称
      const problemNames = processedData[0].problems.map(p => p.name);
      
      // 准备图表数据
      const labels = processedData.map(item => {
        const date = new Date(item.timestamp);
        if (timeDimension === 'hour') {
          return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:00`;
        } else {
          return `${date.getMonth() + 1}/${date.getDate()}`;
        }
      });
      
      const datasets = problemNames.map((name, index) => {
        // 为每个问题生成不同的颜色
        const colors = [
          'rgba(255, 99, 132, 1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)'
        ];
        
        return {
          label: name,
          data: processedData.map(item => {
            const problem = item.problems.find(p => p.name === name);
            return problem ? problem.online_users : 0;
          }),
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length].replace('1)', '0.2)'),
          tension: 0.1
        };
      });
      
      // 销毁旧图表（如果存在）
      if (window.trendChart) {
        window.trendChart.destroy();
      }
      
      // 创建图表
      window.trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            title: {
              display: true,
              text: timeDimension === 'hour' ? lang.chartTitleHour : lang.chartTitleDay
            },
            legend: {
              position: 'bottom'
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'x'
              },
              zoom: {
                wheel: {
                  enabled: true
                },
                pinch: {
                  enabled: true
                },
                mode: 'x'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: lang.chartYAxis
              }
            },
            x: {
              title: {
                display: true,
                text: timeDimension === 'hour' ? lang.chartXAxisHour : lang.chartXAxisDay
              },
              grid: {
                display: true
              }
            }
          }
        }
      });
    }

    // 初始化页面
    async function init() {
      const language = document.getElementById('language').value;
      updateUI(language);
      
      const data = await loadData();
      generateProblemCards(data);
      const timeWindow = document.getElementById('timeWindow').value;
      const timeDimension = document.getElementById('timeDimension').value;
      const filteredData = filterDataByTimeWindow(data, timeWindow);
      drawTrendChart(filteredData, timeDimension);
    }

    // 页面加载完成后初始化
    window.onload = init;
  </script>
</body>
</html>